---
- name: Install and Configure MongoDB on CentOS 9
  hosts: n1
  become: true
  vars:
    mongodb_primary_ip: "172.31.86.23"
    mongodb_admin_user: "Eniola"
    mongodb_admin_password: "admin123!"
  tasks:
    - name: Add MongoDB GPG key
      rpm_key:
        state: present
        key: "https://www.mongodb.org/static/pgp/server-7.0.asc"
    
    - name: Add MongoDB repository
      yum_repository:
        name: mongodb-org-7.0
        description: MongoDB Repository
        baseurl: https://repo.mongodb.org/yum/redhat/9/mongodb-org/7.0/x86_64/
        gpgcheck: yes
        gpgkey: https://www.mongodb.org/static/pgp/server-7.0.asc
        enabled: yes
    
    - name: Install MongoDB packages
      dnf:
        name:
          - mongodb-org
          - mongodb-org-server
          - mongodb-mongosh
          - mongodb-database-tools
        state: present
    
    - name: Create custom MongoDB config directory
      file:
        path: /etc/mongod.conf.d
        state: directory
        mode: 0755
    
    - name: Create MongoDB configuration file
      copy:
        dest: /etc/mongod.conf
        content: |
          # mongod.conf
          
          # Where and how to store data.
          storage:
            dbPath: /var/lib/mongo
            journal:
              enabled: true
          
          # where to write logging data.
          systemLog:
            destination: file
            logAppend: true
            path: /var/log/mongodb/mongod.log
          
          # network interfaces
          net:
            port: 27017
            bindIp: 0.0.0.0  # Allow connections from any IP
          
          # security settings
          security:
            authorization: enabled
        owner: root
        group: root
        mode: 0644
      notify: restart mongod
    
    - name: Create MongoDB log directory
      file:
        path: /var/log/mongodb
        state: directory
        owner: mongod
        group: mongod
        mode: 0755
    
    - name: Start and enable MongoDB service
      service:
        name: mongod
        state: started
        enabled: yes
    
    - name: Install PyMongo dependency
      block:
        - name: Install pip (if not present)
          dnf:
            name: python3-pip
            state: present
        
        - name: Install PyMongo using pip
          pip:
            name: pymongo
            executable: pip3
          register: pip_install
          until: pip_install is succeeded
          retries: 3
          delay: 5
    
    - name: Wait for MongoDB to start accepting connections
      wait_for:
        host: "{{ mongodb_primary_ip }}"
        port: 27017
        delay: 10
        timeout: 60
    
    - name: Initialize MongoDB for first admin user (disable auth temporarily)
      block:
        - name: Update MongoDB config to disable auth temporarily
          copy:
            dest: /etc/mongod.conf
            content: |
              # mongod.conf
              
              # Where and how to store data.
              storage:
                dbPath: /var/lib/mongo
                journal:
                  enabled: true
              
              # where to write logging data.
              systemLog:
                destination: file
                logAppend: true
                path: /var/log/mongodb/mongod.log
              
              # network interfaces
              net:
                port: 27017
                bindIp: 0.0.0.0
            owner: root
            group: root
            mode: 0644
        
        - name: Restart MongoDB to apply configuration
          service:
            name: mongod
            state: restarted
        
        - name: Wait for MongoDB to restart
          wait_for:
            host: "{{ mongodb_primary_ip }}"
            port: 27017
            delay: 5
            timeout: 30
      
    - name: Create admin user without authentication
      mongodb_user:
        login_host: "{{ mongodb_primary_ip }}"
        login_port: 27017
        database: admin
        name: "{{ mongodb_admin_user }}"
        password: "{{ mongodb_admin_password }}"
        roles: "root"
        state: present
      register: user_creation
      until: user_creation is succeeded
      retries: 3
      delay: 5
    
    - name: Re-enable security after user creation
      copy:
        dest: /etc/mongod.conf
        content: |
          # mongod.conf
          
          # Where and how to store data.
          storage:
            dbPath: /var/lib/mongo
            journal:
              enabled: true
          
          # where to write logging data.
          systemLog:
            destination: file
            logAppend: true
            path: /var/log/mongodb/mongod.log
          
          # network interfaces
          net:
            port: 27017
            bindIp: 0.0.0.0
          
          # security settings
          security:
            authorization: enabled
        owner: root
        group: root
        mode: 0644
      notify: restart mongod
    
    - name: Update test page
      template:
        src: html.j2
        dest: /var/www/html/index.html
      ignore_errors: yes
  
  handlers:
    - name: restart mongod
      service:
        name: mongod
        state: restarted
...